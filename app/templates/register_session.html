<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Log Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="gradient-skyfall">
  <div class="center-box">
    <div class="formulario">
      <form id="registroForm" class="payment-form">
        <label for="proveedor">Provider:</label>
        <select id="proveedor" name="proveedor">
          <option value="">Selectt</option>
          {% for proveedor in proveedores %}
            <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
          {% endfor %}
        </select>

        <label for="fecha">Date:</label>
        <input type="date" id="fecha" name="fecha">

        <label for="cantidad">Number</label>
        <input type="number" id="cantidad" name="cantidad" min="1">
        <label for="precioHora">Precio por hora:</label>
        <input type="number" id="precioHora" name="precioHora" min="0" step="0.01">

        <div id="totalCalculo">
            <strong>Total: $</strong><span id="totalMonto">0.00</span>
        </div>
        <button type="submit" class="btn">Register</button>
      </form>

      <div class="confirmacion" id="mensaje"></div>
    </div>
  </div>

  <script>
    document.getElementById("registroForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const provider_id = document.getElementById("proveedor").value;
      const fecha = document.getElementById("fecha").value;
      const cantidad = document.getElementById("cantidad").value;
      const precioHora = document.getElementById("precioHora").value;
      const total = cantidad * precioHora;
      fetch("/register-session", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          provider_id: provider_id,
          fecha: fecha,
          cantidad: cantidad,
          precioHora: precioHora,
          total: total
        })
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("mensaje").textContent = data.mensaje || "Registro confirmado";
      });
    });
    
    // Actualiza el total precioXhora * cantidad 
    function actualizarTotal() {
      const cantidad = document.getElementById("cantidad").value || 0;
      const precioHora = document.getElementById("precioHora").value || 0;
      const total = (cantidad * precioHora).toFixed(2);
      document.getElementById("totalMonto").textContent = total;
    }

    document.getElementById("cantidad").addEventListener("input", actualizarTotal);
    document.getElementById("precioHora").addEventListener("input", actualizarTotal);

    // Busca en Mongo el precioXhora registrado del provider
    function cargarPrecioProvider(providerId) {
        if (!providerId) return;
        
        fetch(`/get-provider/${providerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.costoxh) {
                    document.getElementById("precioHora").value = data.costoxh;
                    actualizarTotal(); // Actualizar el total cuando cambie el precio
                }
            })
            .catch(error => console.error('Error:', error));
    }
  </script>
</body>
</html>
